name: Build Rust Sniper Windows EXE

on:
  workflow_dispatch:
  push:
    branches: [ main, master ]

jobs:
  build:
    runs-on: windows-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Cache Rust toolchain
      uses: actions/cache@v4
      with:
        path: |
          ~/.rustup
        key: ${{ runner.os }}-rust-toolchain-v1-${{ hashFiles('rust-toolchain.toml') }}
        restore-keys: |
          ${{ runner.os }}-rust-toolchain-v1-
    
    - name: Cache Cargo registry
      uses: actions/cache@v4
      with:
        path: |
          ~/.cargo/registry
          ~/.cargo/git
        key: ${{ runner.os }}-cargo-registry-v1-${{ hashFiles('sniper_backup/Cargo.lock') }}
        restore-keys: |
          ${{ runner.os }}-cargo-registry-v1-
    
    - name: Cache Cargo build
      uses: actions/cache@v4
      with:
        path: |
          sniper_backup/target
          target
        key: ${{ runner.os }}-cargo-build-v1-${{ hashFiles('sniper_backup/Cargo.lock') }}-${{ github.sha }}
        restore-keys: |
          ${{ runner.os }}-cargo-build-v1-${{ hashFiles('sniper_backup/Cargo.lock') }}-
          ${{ runner.os }}-cargo-build-v1-
    
    - name: Cache MSYS2
      uses: actions/cache@v4
      with:
        path: C:\msys64
        key: ${{ runner.os }}-msys2-v1
        restore-keys: |
          ${{ runner.os }}-msys2-v1
    
    - name: Cache Chocolatey
      uses: actions/cache@v4
      with:
        path: C:\ProgramData\chocolatey
        key: ${{ runner.os }}-choco-v1
        restore-keys: |
          ${{ runner.os }}-choco-v1
    
    - name: Install Rust
      uses: dtolnay/rust-toolchain@stable
      with:
        targets: x86_64-pc-windows-gnu
    
    - name: Setup MSYS2 and Chocolatey
      shell: pwsh
      run: |
        if (!(Test-Path "C:\msys64")) {
          choco install msys2 --params "/NoPath" -y
          Start-Sleep -Seconds 10
        }
        # Всегда проверяем и устанавливаем autoconf, automake, make (даже если MSYS2 закеширован)
        $env:CHERE_INVOKING = "1"
        $env:MSYSTEM = "MINGW64"
        $env:PATH = "C:\msys64\usr\bin;C:\msys64\mingw64\bin;$env:PATH"
        
        # Обновляем базу пакетов
        & "C:\msys64\usr\bin\bash.exe" -lc "pacman -Sy --noconfirm"
        
        # Устанавливаем необходимые пакеты
        $autoconfPath = "C:\msys64\usr\bin\autoconf.exe"
        $automakePath = "C:\msys64\usr\bin\automake.exe"
        $zstdPath = "C:\msys64\mingw64\bin\zstd.exe"
        if (!(Test-Path $autoconfPath) -or !(Test-Path $automakePath) -or !(Test-Path $zstdPath)) {
          & "C:\msys64\usr\bin\bash.exe" -lc "pacman -S --noconfirm autoconf automake make gcc mingw-w64-x86_64-zstd mingw-w64-x86_64-pkg-config"
        }
        
        if (!(Test-Path "C:\ProgramData\chocolatey\bin\protoc.exe")) {
          choco install protoc -y
        }
    
    - name: Build
      shell: bash
      run: |
        export PATH="$HOME/.cargo/bin:$PATH"
        export RUST_BACKTRACE=1
        export PROTOC="/c/ProgramData/chocolatey/bin/protoc.exe"
        export CC="gcc"
        export CXX="g++"
        export MAKE="make"
        # Важно: сначала /usr/bin для autoconf/automake, потом mingw64/bin для gcc и zstd
        export PATH="/c/msys64/usr/bin:/c/msys64/mingw64/bin:$PATH"
        # Отключаем pkg-config для zstd и используем встроенную компиляцию из исходников
        # Это избегает проблем с кросс-компиляцией pkg-config
        export LIBZSTD_NO_PKG_CONFIG=1
        export ZSTD_SYS_USE_PKG_CONFIG=0
        
        # Проверяем что все инструменты доступны
        cargo --version
        autoconf --version || echo "autoconf not found"
        automake --version || echo "automake not found"
        gcc --version
        make --version
        
        # Определяем working directory
        if [ -f "sniper_backup/Cargo.toml" ]; then
          cd sniper_backup
        fi
        
        cargo build --release --target x86_64-pc-windows-gnu --verbose
    
    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: rust-sniper-windows
        path: |
          sniper_backup/target/x86_64-pc-windows-gnu/release/rust-sniper.exe
          target/x86_64-pc-windows-gnu/release/rust-sniper.exe
        retention-days: 30
        if-no-files-found: error
